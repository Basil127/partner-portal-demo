services:
  frontend:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./app/frontend/Dockerfile
      target: prod
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001}
    image: ohm-demo-frontend:${VERSION:-latest}
    env_file:
      - path: .env
        required: false
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3001}
      - PORT=3000
    ports:
      - "3000:3000"
    depends_on:
      - backend
  
  backend:
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./app/backend/Dockerfile
      target: prod
    image: ohm-demo-backend:${VERSION:-latest}
    env_file:
      - path: .env
        required: false
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3001}
      - HOST=${HOST:-0.0.0.0}
      - DB_TYPE=${DB_TYPE:-postgres}
      - DB_HOST=${DB_HOST:-OperaClone2-db}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-OperaClone2}
      - DB_USER=${DB_USER:-OperaClone2}
      - DB_PASSWORD=${DB_PASSWORD:-OperaClone2}
      - JWT_SECRET=${JWT_SECRET}
      - SESSION_SECRET=${SESSION_SECRET}
      - EXTERNAL_CLIENT_BASE_URL=${EXTERNAL_CLIENT_BASE_URL:-http://mock-api:8000}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
    ports:
      - "3001:3001"
    volumes:
      - backend-data:/app/app/backend/data
    depends_on:
      - mock-api
      - db
  
  mock-api: &mock-api
    restart: unless-stopped
    build:
      context: .
      dockerfile: ./app/mock-api/Dockerfile
      target: prod
    image: ohm-demo-mock-api:${VERSION:-latest}
    env_file:
      - path: .env
        required: false
    depends_on:
      db:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    environment:
      OPERACLONE2_HOST: 0.0.0.0
      OPERACLONE2_DB_HOST: OperaClone2-db
      OPERACLONE2_DB_PORT: 5432
      OPERACLONE2_DB_USER: OperaClone2
      OPERACLONE2_DB_PASS: OperaClone2
      OPERACLONE2_DB_BASE: OperaClone2
      OPERACLONE2_CORS_ORIGINS: ${CORS_ORIGINS:-*}
    ports:
      - "8000:8000"

  db:
    restart: unless-stopped
    image: postgres:18.1-bookworm
    hostname: OperaClone2-db
    environment:
      POSTGRES_PASSWORD: "OperaClone2"
      POSTGRES_USER: "OperaClone2"
      POSTGRES_DB: "OperaClone2"
    ports:
      - "5432:5432"
    volumes:
      - OperaClone2-db-data:/var/lib/postgresql
    healthcheck:
      test: pg_isready -U OperaClone2
      interval: 2s
      timeout: 3s
      retries: 40

  migrator:
    <<: *mock-api
    restart: "no"
    ports: []
    command: alembic upgrade head
    depends_on:
      db:
        condition: service_healthy


volumes:
  OperaClone2-db-data:
    name: OperaClone2-db-data
  backend-data:
    name: backend-data
